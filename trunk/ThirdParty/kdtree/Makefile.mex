CC=g++
LD=g++

DEBUG = 1

BUILDDIR = ./build
SRCDIR = .
INCLUDEDIR = .
BINDIR = .

CPPFLAGS=-I$(INCLUDEDIR) --std=c++11
ifdef DEBUG
CPPFLAGS:=$(CPPFLAGS) -g -O0 -DDEBUG
else
CPPFLAGS:=$(CPPFLAGS) -O3
endif
LDFLAGS = 

# Matlab folders
ifndef MATLAB_ROOT
MATLAB_ROOT:="C:/Program Files/MATLAB/R2013b"
endif
ifndef MATLAB_BINDIR
MATLAB_BINDIR:="$(MATLAB_ROOT)/bin/win64"
endif
ifndef MEX_EXT
MEX_EXT:=mexw64
endif
ifndef MATLAB_INCLUDEDIR
MATLAB_INCLUDEDIR:="$(MATLAB_ROOT)/extern/include"
endif

MEX_CPPFLAGS:=$(CPPFLAGS) -DMX_COMPAT_32 -DMATLAB_MEX_FILE -I"$(MATLAB_INCLUDEDIR)" -Wall
MEX_LDFLAGS:= $(LDFLAGS) -shared -L"$(MATLAB_BINDIR)" -lstdc++ -lmex -lmx -lmat

MEX_SOURCES = kdtree_build.cpp kdtree_ball_query.cpp kdtree_delete.cpp kdtree_k_nearest_neighbors.cpp kdtree_nearest_neighbor.cpp kdtree_range_query.cpp

MEX_OBJECTS = $(patsubst %.cpp, $(BUILDDIR)/%.mexo, $(MEX_SOURCES))
MEX = $(patsubst %.cpp, $(BINDIR)/%.$(MEX_EXT), $(MEX_SOURCES))

HEADERS := KDTree.h MyHeaps.h
# $(notdir $(MEX_SOURCES:.cpp=.$(MEX_EXT))))

MKDIR_CMD=mkdir -p $(@D)

default: all

cleanup:
	rm -rf $(OBJECTS) $(MEX_OBJECTS) $(CMD_OBJECTS)

clean: cleanup
	# $(M_FILES_OUT)
	rm -rf $(CMD) $(MEX) $(LIB) 

# do not delete intermediates
.SECONDARY:

vars:
	@echo "MEX_SOURCES: $(MEX_SOURCES)"
	@echo "MEX_OBJECTS: $(MEX_OBJECTS)"
	@echo "MEX_CPPFLAGS: $(MEX_CPPFLAGS)"
	@echo "MEX_LDFLAGS: $(MEX_LDFLAGS)"
	@echo "MEX: $(MEX)"
	

default: all
all: mex

mex: $(MEX)

$(BUILDDIR)/%.mexo: $(SRCDIR)/%.cpp
	@$(MKDIR_CMD)
	@echo Compiling $@...
	@$(CC) $(MEX_CPPFLAGS) -o $@ -c $<

$(BINDIR)/%.$(MEX_EXT): $(BUILDDIR)/%.mexo $(OBJECTS)
	@$(MKDIR_CMD)
	@echo Assembling $@ ...
	@$(LD) -o $@ $(MEX_LDFLAGS) $(OBJECTS) $<
	@echo Complete!
